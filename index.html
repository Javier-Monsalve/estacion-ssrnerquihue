<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Estaci√≥n Meteorol√≥gica SSR Nerquihue</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body {
    background: #bdbdbd;
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    color: #000;
  }

  /* === Encabezado === */
  header {
    background: #039be5;
    color: white;
    text-align: center;
    padding: 15px;
    font-size: 20px;
    font-weight: bold;
  }

  /* === Contenedor general === */
  .contenedor {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
  }

  /* === Fila superior: datos === */
  .fila-datos {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
    margin-bottom: 30px;
  }

  .tarjeta {
    background: white;
    border: 2px solid #0288d1;
    border-radius: 6px;
    width: 180px;
    height: 90px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  .tarjeta .titulo {
    font-weight: bold;
    margin-bottom: 5px;
  }

  .tarjeta .valor {
    font-size: 20px;
    font-weight: bold;
  }

  /* === Fila inferior: gr√°ficos === */
  .fila-graficos {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
  }

  .grafico {
    background: white;
    border: 2px solid #0288d1;
    border-radius: 6px;
    width: 300px;
    height: 220px;
    padding: 10px;
  }

  #cerrarSesion {
    margin-top: 25px;
    background: #e53935;
    border: none;
    color: white;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
  }

  #cerrarSesion:hover {
    background: #c62828;
  }

  /* === Login === */
  #login {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .login-box {
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.3);
    width: 300px;
    text-align: center;
  }

  .login-box h2 {
    margin-bottom: 20px;
    color: #1976d2;
  }

  .login-box input {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border-radius: 6px;
    border: 1px solid #ccc;
  }

  .login-box button {
    width: 100%;
    padding: 10px;
    background: #1976d2;
    border: none;
    border-radius: 6px;
    color: white;
    font-weight: bold;
    cursor: pointer;
  }

  .login-box button:hover {
    background: #1565c0;
  }

  .error {
    color: red;
    font-size: 14px;
  }

  #contenido { display: none; }
</style>
</head>

<body>
  <!-- === LOGIN === -->
  <div id="login">
    <div class="login-box">
      <h2>Iniciar Sesi√≥n</h2>
      <input type="text" id="usuario" placeholder="Usuario">
      <input type="password" id="clave" placeholder="Contrase√±a">
      <button onclick="verificarLogin()">Entrar</button>
      <div id="error" class="error"></div>
    </div>
  </div>

  <!-- === DASHBOARD === -->
  <div id="contenido">
    <header>üå§ Estaci√≥n Meteorol√≥gica SSR Nerquihue</header>

    <div class="contenedor">
      <div class="fila-datos">
        <div class="tarjeta">
          <div class="titulo">Temperatura</div>
          <div id="temp" class="valor">-- ¬∞C</div>
        </div>
        <div class="tarjeta">
          <div class="titulo">Humedad</div>
          <div id="hum" class="valor">-- %</div>
        </div>
        <div class="tarjeta">
          <div class="titulo">Lluvia Ca√≠da</div>
          <div id="lluvia" class="valor">-- mm</div>
        </div>
        <div class="tarjeta">
          <div class="titulo">Fecha</div>
          <div id="fecha" class="valor">--</div>
        </div>
        <div class="tarjeta">
          <div class="titulo">Pron√≥stico</div>
          <div id="pronostico" class="valor">--</div>
        </div>
      </div>

      <div class="fila-graficos">
        <div class="grafico">
          <canvas id="grafTemp"></canvas>
        </div>
        <div class="grafico">
          <canvas id="grafHum"></canvas>
        </div>
        <div class="grafico">
          <canvas id="grafLluvia"></canvas>
        </div>
      </div>

      <button id="cerrarSesion" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
    </div>
  </div>

<script>
  const USUARIO_CORRECTO = "SSR NERQUIHUE";
  const CLAVE_CORRECTA = "nerquihue2025";
  const TIEMPO_SESION = 5 * 60 * 1000; // 5 minutos

  window.onload = () => {
    const sesion = JSON.parse(localStorage.getItem("sesionSSRNERQUIHUE"));
    const ahora = new Date().getTime();
    if (sesion && ahora < sesion.expira) {
      mostrarContenido();
      iniciarMQTT();
    } else cerrarSesion();
  };

  function verificarLogin() {
    const user = document.getElementById("usuario").value.trim();
    const pass = document.getElementById("clave").value.trim();
    const error = document.getElementById("error");

    if (user === USUARIO_CORRECTO && pass === CLAVE_CORRECTA) {
      const expira = new Date().getTime() + TIEMPO_SESION;
      localStorage.setItem("sesionSSRNERQUIHUE", JSON.stringify({expira}));
      mostrarContenido();
      iniciarMQTT();
    } else error.textContent = "Usuario o contrase√±a incorrectos.";
  }

  function mostrarContenido() {
    document.getElementById("login").style.display = "none";
    document.getElementById("contenido").style.display = "block";
  }

  function cerrarSesion() {
    localStorage.removeItem("sesionSSRNERQUIHUE");
    document.getElementById("contenido").style.display = "none";
    document.getElementById("login").style.display = "flex";
    document.getElementById("usuario").value = "";
    document.getElementById("clave").value = "";
    document.getElementById("error").textContent = "";
  }

  // === MQTT ===
  let client;
  function iniciarMQTT() {
    const broker = "wss://broker.emqx.io:8084/mqtt";
    const options = {
      clean: true,
      connectTimeout: 4000,
      clientId: "web_mqtt_" + Math.random().toString(16).substr(2, 8),
    };

    client = mqtt.connect(broker, options);

    client.on("connect", () => {
      console.log("‚úÖ Conectado a broker.emqx.io");
      client.subscribe("estacion/temperatura");
      client.subscribe("estacion/humedad");
      client.subscribe("estacion/lluvia2min");
      client.subscribe("estacion/fecha");
      client.subscribe("estacion/pronostico");
    });

    client.on("message", (topic, message) => {
      const valor = message.toString();
      switch (topic) {
        case "estacion/temperatura": actualizarValor("temp", valor + " ¬∞C"); agregarDato(graficoTemp, valor); break;
        case "estacion/humedad": actualizarValor("hum", valor + " %"); agregarDato(graficoHum, valor); break;
        case "estacion/lluvia2min": actualizarValor("lluvia", valor + " mm"); agregarDato(graficoLluvia, valor); break;
        case "estacion/fecha": actualizarValor("fecha", valor); break;
        case "estacion/pronostico": actualizarValor("pronostico", valor); break;
      }
    });
  }

  function actualizarValor(id, texto) {
    document.getElementById(id).innerText = texto;
  }

  // === Gr√°ficos ===
  const graficoTemp = crearGrafico("grafTemp", "Temperatura (¬∞C)", "#ef5350");
  const graficoHum = crearGrafico("grafHum", "Humedad (%)", "#42a5f5");
  const graficoLluvia = crearGrafico("grafLluvia", "Lluvia (mm)", "#26a69a");

  function crearGrafico(id, label, color) {
    const ctx = document.getElementById(id).getContext("2d");
    return new Chart(ctx, {
      type: "line",
      data: { labels: [], datasets: [{ label, data: [], borderColor: color, fill: false }] },
      options: { scales: { x: { display: false } }, responsive: true, maintainAspectRatio: false }
    });
  }

  function agregarDato(chart, valor) {
    const num = parseFloat(valor);
    if (isNaN(num)) return;
    chart.data.labels.push("");
    chart.data.datasets[0].data.push(num);
    if (chart.data.labels.length > 20) {
      chart.data.labels.shift();
      chart.data.datasets[0].data.shift();
    }
    chart.update();
  }
</script>
</body>
</html>
