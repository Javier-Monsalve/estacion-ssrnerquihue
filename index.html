<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EstaciÃ³n MeteorolÃ³gica SSR Nerquihue</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
Â  body { background: #bdbdbd; font-family: Arial, sans-serif; margin: 0; padding: 0; color: #000; }
Â  header { background: #039be5; color: white; text-align: center; padding: 15px; font-size: 20px; font-weight: bold; position: relative; }
  .logo { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); height: 40px; } /* Ajusta la altura segÃºn sea necesario */
Â  .contenedor { display: flex; flex-direction: column; align-items: center; padding: 20px; }
Â  .fila-datos { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 30px; }
Â  .tarjeta {
Â  Â  background: white; border: 2px solid #0288d1; border-radius: 6px;
Â  Â  width: 200px; height: 95px; display: flex; flex-direction: column;
Â  Â  justify-content: center; align-items: center; transition: all 0.3s;
Â  }
Â  .tarjeta:hover { transform: scale(1.04); }
Â  .tarjeta .titulo { font-weight: bold; margin-bottom: 5px; }
Â  .tarjeta .valor { font-size: 21px; font-weight: bold; }
Â  .fila-graficos { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
Â  .grafico {
Â  Â  background: white; border: 2px solid #0288d1; border-radius: 6px;
Â  Â  width: 360px; height: 240px; padding: 10px;
Â  }
Â  #cerrarSesion {
Â  Â  margin-top: 25px; background: #e53935; border: none; color: white;
Â  Â  padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold;
Â  }
Â  #cerrarSesion:hover { background: #c62828; }
Â  #login { position: fixed; top: 0; left: 0; width: 100%; height: 100%;
Â  Â  background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; }
Â  .login-box {
Â  Â  background: white; padding: 30px; border-radius: 10px;
Â  Â  box-shadow: 0 3px 8px rgba(0,0,0,0.3); width: 300px; text-align: center;
Â  }
Â  .login-box h2 { margin-bottom: 20px; color: #1976d2; }
Â  .login-box input {
Â  Â  width: 100%; padding: 10px; margin: 8px 0; border-radius: 6px; border: 1px solid #ccc;
Â  }
Â  .login-box button {
Â  Â  width: 100%; padding: 10px; background: #1976d2; border: none;
Â  Â  border-radius: 6px; color: white; font-weight: bold; cursor: pointer;
Â  }
Â  .login-box button:hover { background: #1565c0; }
Â  .error { color: red; font-size: 14px; }
Â  #contenido { display: none; }
</style>
</head>

<body>
Â  Â  <div id="login">
Â  Â  <div class="login-box">
Â  Â  Â  <h2>Iniciar SesiÃ³n</h2>
Â  Â  Â  <input type="text" id="usuario" placeholder="Usuario">
Â  Â  Â  <input type="password" id="clave" placeholder="ContraseÃ±a">
Â  Â  Â  <button onclick="verificarLogin()">Entrar</button>
Â  Â  Â  <div id="error" class="error"></div>
Â  Â  </div>
Â  </div>

Â  Â  <div id="contenido">
Â  Â  <header>
      <img src="https://i.imgur.com/uR1d7P2.png" alt="Logo" class="logo">
      ðŸŒ¤ EstaciÃ³n MeteorolÃ³gica SSR Nerquihue
    </header>

Â  Â  <div class="contenedor">
Â  Â  Â  <div class="fila-datos">
Â  Â  Â  Â  <div class="tarjeta"><div class="titulo">Temperatura</div><div id="temp" class="valor">-- Â°C</div></div>
Â  Â  Â  Â  <div class="tarjeta"><div class="titulo">Humedad</div><div id="hum" class="valor">-- %</div></div>
Â  Â  Â  Â  <div class="tarjeta"><div class="titulo">Lluvia CaÃ­da</div><div id="lluvia" class="valor">-- mm</div></div>
Â  Â  Â  Â  <div class="tarjeta"><div class="titulo">Fecha</div><div id="fecha" class="valor">--</div></div>
Â  Â  Â  Â  <div class="tarjeta"><div class="titulo">PronÃ³stico</div><div id="pronostico" class="valor">--</div></div>
Â  Â  Â  </div>

Â  Â  Â  <div class="fila-graficos">
Â  Â  Â  Â  <div class="grafico"><canvas id="grafTemp"></canvas></div>
Â  Â  Â  Â  <div class="grafico"><canvas id="grafHum"></canvas></div>
Â  Â  Â  Â  <div class="grafico"><canvas id="grafLluvia"></canvas></div>
Â  Â  Â  </div>

Â  Â  Â  <button id="cerrarSesion" onclick="cerrarSesion()">Cerrar SesiÃ³n</button>
Â  Â  </div>
Â  </div>

<script>
Â  const USUARIO_CORRECTO = "SSR NERQUIHUE";
Â  const CLAVE_CORRECTA = "nerquihue2025";
Â  const TIEMPO_SESION = 5 * 60 * 1000;
Â  const MAX_DATOS = 24;Â  // ðŸ”¹ SOLO SE MANTENDRÃN LOS ÃšLTIMOS 24 DATOS

Â  let ultimaHora = "--";

Â  window.onload = () => {
Â  Â  const sesion = JSON.parse(localStorage.getItem("sesionSSRNERQUIHUE"));
Â  Â  const ahora = new Date().getTime();
Â  Â  if (sesion && ahora < sesion.expira) {
Â  Â  Â  mostrarContenido();
Â  Â  Â  iniciarMQTT();
Â  Â  Â  cargarHistorial();
Â  Â  } else cerrarSesion();
Â  };

Â  function verificarLogin() {
Â  Â  const user = document.getElementById("usuario").value.trim();
Â  Â  const pass = document.getElementById("clave").value.trim();
Â  Â  const error = document.getElementById("error");
Â  Â  if (user === USUARIO_CORRECTO && pass === CLAVE_CORRECTA) {
Â  Â  Â  const expira = new Date().getTime() + TIEMPO_SESION;
Â  Â  Â  localStorage.setItem("sesionSSRNERQUIHUE", JSON.stringify({expira}));
Â  Â  Â  mostrarContenido();
Â  Â  Â  iniciarMQTT();
Â  Â  Â  cargarHistorial();
Â  Â  } else error.textContent = "Usuario o contraseÃ±a incorrectos.";
Â  }

Â  function mostrarContenido() {
Â  Â  document.getElementById("login").style.display = "none";
Â  Â  document.getElementById("contenido").style.display = "block";
Â  }

Â  function cerrarSesion() {
Â  Â  localStorage.removeItem("sesionSSRNERQUIHUE");
Â  Â  document.getElementById("contenido").style.display = "none";
Â  Â  document.getElementById("login").style.display = "flex";
Â  Â  document.getElementById("usuario").value = "";
Â  Â  document.getElementById("clave").value = "";
Â  Â  document.getElementById("error").textContent = "";
Â  }

Â  // === MQTT ===
Â  let client;
Â  function iniciarMQTT() {
Â  Â  const broker = "wss://broker.emqx.io:8084/mqtt";
Â  Â  const options = { clean: true, connectTimeout: 4000, clientId: "web_mqtt_" + Math.random().toString(16).substr(2, 8) };
Â  Â  client = mqtt.connect(broker, options);

Â  Â  client.on("connect", () => {
Â  Â  Â  console.log("âœ… Conectado a broker.emqx.io");
Â  Â  Â  client.subscribe("estacion/temperatura");
Â  Â  Â  client.subscribe("estacion/humedad");
Â  Â  Â  client.subscribe("estacion/lluvia2min");
Â  Â  Â  client.subscribe("estacion/fecha");
Â  Â  Â  client.subscribe("estacion/pronostico");
Â  Â  });

Â  Â  client.on("message", (topic, message) => {
Â  Â  Â  const valor = message.toString();
Â  Â  Â  switch (topic) {
Â  Â  Â  Â  case "estacion/fecha": ultimaHora = valor.split(" ")[1] || valor; actualizarValor("fecha", valor); break;
Â  Â  Â  Â  case "estacion/temperatura": actualizarValor("temp", valor + " Â°C"); agregarDato(graficoTemp, ultimaHora, valor, "temp"); break;
Â  Â  Â  Â  case "estacion/humedad": actualizarValor("hum", valor + " %"); agregarDato(graficoHum, ultimaHora, valor, "hum"); break;
Â  Â  Â  Â  case "estacion/lluvia2min": actualizarValor("lluvia", valor + " mm"); agregarDato(graficoLluvia, ultimaHora, valor, "lluvia"); break;
Â  Â  Â  Â  case "estacion/pronostico": actualizarValor("pronostico", valor); break;
Â  Â  Â  }
Â  Â  });
Â  }

Â  function actualizarValor(id, texto) { document.getElementById(id).innerText = texto; }

Â  // === GRÃFICOS ===
Â  const graficoTemp = crearGrafico("grafTemp", "Temperatura (Â°C)", "#ef5350");
Â  const graficoHum = crearGrafico("grafHum", "Humedad (%)", "#42a5f5");
Â  const graficoLluvia = crearGrafico("grafLluvia", "Lluvia (mm)", "#26a69a");

Â  function crearGrafico(id, label, color) {
Â  Â  const ctx = document.getElementById(id).getContext("2d");
Â  Â  return new Chart(ctx, {
Â  Â  Â  type: "line",
Â  Â  Â  data: { labels: [], datasets: [{
Â  Â  Â  Â  label, data: [], borderColor: color, fill: false,
Â  Â  Â  Â  tension: 0.3, pointRadius: 3, pointBackgroundColor: color, borderWidth: 2
Â  Â  Â  }] },
Â  Â  Â  options: {
Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  x: { title: { display: true, text: "Hora" }, ticks: { autoSkip: true, maxTicksLimit: 6 } },
Â  Â  Â  Â  Â  y: { beginAtZero: false, ticks: { precision: 2 } } // ðŸ”¹ EJE Y AUTOAJUSTABLE
Â  Â  Â  Â  },
Â  Â  Â  Â  plugins: { legend: { labels: { boxWidth: 20, font: { size: 12, weight: 'bold' } } } },
Â  Â  Â  Â  responsive: true, maintainAspectRatio: false
Â  Â  Â  }
Â  Â  });
Â  }

Â  function agregarDato(chart, hora, valor, tipo) {
Â  Â  const num = parseFloat(valor);
Â  Â  if (isNaN(num)) return;
Â  Â  chart.data.labels.push(hora);
Â  Â  chart.data.datasets[0].data.push(num);
Â  Â  if (chart.data.labels.length > MAX_DATOS) { // ðŸ”¹ BORRA LOS ANTIGUOS
Â  Â  Â  chart.data.labels.shift();
Â  Â  Â  chart.data.datasets[0].data.shift();
Â  Â  }
Â  Â  chart.update();
Â  Â  guardarHistorial(tipo, hora, num);
Â  }

Â  // === HISTORIAL LOCAL ===
Â  function guardarHistorial(tipo, hora, valor) {
Â  Â  let historial = JSON.parse(localStorage.getItem("historial_" + tipo)) || [];
Â  Â  historial.push({hora, valor});
Â  Â  if (historial.length > MAX_DATOS) historial.shift();
Â  Â  localStorage.setItem("historial_" + tipo, JSON.stringify(historial));
Â  }

Â  function cargarHistorial() {
Â  Â  ["temp", "hum", "lluvia"].forEach(tipo => {
Â  Â  Â  let datos = JSON.parse(localStorage.getItem("historial_" + tipo)) || [];
Â  Â  Â  const chart = tipo === "temp" ? graficoTemp : tipo === "hum" ? graficoHum : graficoLluvia;
Â  Â  Â  chart.data.labels = datos.map(d => d.hora);
Â  Â  Â  chart.data.datasets[0].data = datos.map(d => d.valor);
Â  Â  Â  chart.update();
Â  Â  });
Â  }
</script>
</body>
</html>
